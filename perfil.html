<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Perfil | Lumers</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f8fafc; }
        .profile-header { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); }
        .glass-card { background: white; border-radius: 2rem; border: 1px solid rgba(0,0,0,0.03); box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .bottom-nav { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(20px); border-radius: 2.5rem; }
    </style>
</head>
<body class="pb-32">

    <header class="profile-header pt-16 pb-24 px-6 text-center text-white rounded-b-[3rem] shadow-2xl">
        <div class="relative inline-block mb-4">
            <img id="userImg" src="" class="w-24 h-24 rounded-full border-4 border-white/20 shadow-xl object-cover hidden mx-auto">
            <div id="imgPlaceholder" class="w-24 h-24 bg-blue-600 rounded-full flex items-center justify-center text-3xl mx-auto">üë§</div>
        </div>
        <h2 id="userName" class="text-2xl font-black tracking-tight italic">Cargando...</h2>
        <p id="userEmail" class="text-blue-300 text-xs font-bold uppercase tracking-widest mt-1 opacity-70"></p>
        
        <button id="btnLogout" class="mt-6 px-6 py-2 bg-red-500/20 hover:bg-red-500/40 border border-red-500/50 rounded-full text-[10px] font-black uppercase tracking-widest transition-all">
            Cerrar Sesi√≥n
        </button>
    </header>

    <main class="max-w-md mx-auto px-6 -mt-10">
        <div class="flex justify-between items-center mb-6 px-2">
            <h3 class="font-black text-slate-800 text-lg italic">Mis Publicaciones</h3>
            <span id="count" class="bg-blue-600 text-white text-[10px] px-3 py-1 rounded-full font-black">0</span>
        </div>

        <div id="misEnvios" class="space-y-4">
            <div class="text-center py-10 text-slate-400 text-xs font-bold uppercase tracking-widest animate-pulse"> Buscando tus paquetes... </div>
        </div>
    </main>

    <div class="fixed bottom-6 left-1/2 -translate-x-1/2 w-[90%] max-w-md bottom-nav px-8 py-4 flex justify-between items-center shadow-2xl">
        <a href="index.html" class="text-white opacity-40 text-xl">üè†</a>
        <a href="subasta.html" class="text-white opacity-40 text-xl">üåç</a>
        <a href="crear-envio.html" class="bg-blue-600 p-4 rounded-2xl shadow-lg -translate-y-2 text-white font-bold text-2xl">+</a>
        <a href="perfil.html" class="text-white text-2xl">üë§</a>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, where, onSnapshot, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBDWQG6zKK2CDsnHASgE2jtO3DEnU2RsHw",
            authDomain: "lumers-d1d36.firebaseapp.com",
            projectId: "lumers-d1d36",
            storageBucket: "lumers-d1d36.firebasestorage.app",
            messagingSenderId: "798769127070",
            appId: "1:798769127070:web:6b591851e4c5c62758258f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Llenar datos de perfil
                document.getElementById('userName').innerText = user.displayName;
                document.getElementById('userEmail').innerText = user.email;
                if(user.photoURL) {
                    document.getElementById('userImg').src = user.photoURL;
                    document.getElementById('userImg').classList.remove('hidden');
                    document.getElementById('imgPlaceholder').classList.add('hidden');
                }
                cargarMisEnvios(user.uid);
            } else {
                window.location.href = "index.html";
            }
        });

        function cargarMisEnvios(uid) {
            const q = query(
                collection(db, "envios"), 
                where("usuarioId", "==", uid),
                orderBy("fecha", "desc")
            );

            onSnapshot(q, (snapshot) => {
                const contenedor = document.getElementById('misEnvios');
                document.getElementById('count').innerText = snapshot.size;
                contenedor.innerHTML = '';

                if(snapshot.empty) {
                    contenedor.innerHTML = '<div class="glass-card p-10 text-center text-slate-400 text-xs font-bold uppercase">A√∫n no has publicado nada.</div>';
                    return;
                }

                snapshot.forEach(doc => {
                    const data = doc.data();
                    contenedor.innerHTML += `
                        <div class="glass-card p-4 flex items-center gap-4">
                            <img src="${data.foto}" class="w-16 h-16 rounded-2xl object-cover shadow-sm">
                            <div class="flex-1">
                                <h4 class="font-black text-slate-800 text-sm italic">${data.nombre}</h4>
                                <p class="text-[10px] text-blue-600 font-bold uppercase tracking-widest">$${data.valor}</p>
                            </div>
                            <div class="text-[10px] font-black text-slate-300 uppercase italic">Activo</div>
                        </div>
                    `;
                });
            });
        }

        document.getElementById('btnLogout').onclick = () => {
            signOut(auth).then(() => window.location.href = "index.html");
        };
    </script>
</body>
</html>
