<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat de Envío | Lumers</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>body { font-family: 'Plus Jakarta Sans', sans-serif; }</style>
</head>
<body class="bg-slate-50 h-screen flex flex-col">

    <nav class="bg-white border-b border-slate-200 p-4 flex items-center gap-4">
        <button onclick="window.history.back()" class="p-2 hover:bg-slate-100 rounded-full">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
        </button>
        <div>
            <h2 id="tituloChat" class="font-bold text-slate-800 text-lg">Cargando chat...</h2>
            <p class="text-xs text-green-500 font-bold uppercase tracking-wider">En línea ahora</p>
        </div>
    </nav>

    <div id="mensajesChat" class="flex-1 overflow-y-auto p-6 space-y-4 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]">
        </div>

    <div class="p-4 bg-white border-t border-slate-200">
        <div class="max-w-4xl mx-auto flex gap-2">
            <input type="text" id="inputMensaje" placeholder="Escribe un mensaje..." 
                   class="flex-1 p-4 bg-slate-50 rounded-2xl border-none focus:ring-2 focus:ring-blue-500 outline-none">
            <button onclick="enviarMensaje()" class="bg-blue-600 text-white p-4 rounded-2xl hover:bg-blue-700 transition shadow-lg shadow-blue-100">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                </svg>
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBDWQG6zKK2CDsnHASgE2jtO3DEnU2RsHw",
            authDomain: "lumers-d1d36.firebaseapp.com",
            projectId: "lumers-d1d36",
            storageBucket: "lumers-d1d36.firebasestorage.app"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const urlParams = new URLSearchParams(window.location.search);
        const envioId = urlParams.get('id');
        const contenedor = document.getElementById('mensajesChat');

        onAuthStateChanged(auth, async (user) => {
            if (!user) return window.location.href = "index.html";

            // 1. Obtener datos del paquete para el título
            const docRef = doc(db, "envios", envioId);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                document.getElementById('tituloChat').innerText = docSnap.data().nombre;
            }

            // 2. Escuchar mensajes en tiempo real
            const q = query(collection(db, `envios/${envioId}/mensajes`), orderBy("fecha", "asc"));
            onSnapshot(q, (snapshot) => {
                contenedor.innerHTML = '';
                snapshot.forEach((doc) => {
                    const msg = doc.data();
                    const esMio = msg.usuarioId === user.uid;
                    
                    contenedor.innerHTML += `
                        <div class="flex ${esMio ? 'justify-end' : 'justify-start'} animate-in fade-in slide-in-from-bottom-2">
                            <div class="${esMio ? 'bg-blue-600 text-white' : 'bg-white text-slate-800'} px-4 py-3 rounded-2xl max-w-[80%] shadow-sm border border-slate-100">
                                <p class="text-[10px] opacity-70 mb-1 font-bold">${msg.nombre}</p>
                                <p class="text-sm leading-relaxed">${msg.texto}</p>
                            </div>
                        </div>`;
                });
                contenedor.scrollTop = contenedor.scrollHeight;
            });

            // 3. Función para enviar mensaje
            window.enviarMensaje = async () => {
                const input = document.getElementById('inputMensaje');
                if (!input.value.trim()) return;

                const texto = input.value;
                input.value = '';

                await addDoc(collection(db, `envios/${envioId}/mensajes`), {
                    texto: texto,
                    nombre: user.displayName,
                    usuarioId: user.uid,
                    fecha: serverTimestamp()
                });

                // Crear notificación para el dueño (opcional)
                if (user.uid !== docSnap.data().usuarioId) {
                    await addDoc(collection(db, "notificaciones"), {
                        para: docSnap.data().usuarioId,
                        texto: `Nuevo mensaje en tu envío: ${docSnap.data().nombre}`,
                        leido: false,
                        fecha: serverTimestamp()
                    });
                }
            };
        });

        // Enviar con la tecla Enter
        document.getElementById('inputMensaje').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') enviarMensaje();
        });
    </script>
</body>
</html>
