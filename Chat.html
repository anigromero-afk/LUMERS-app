<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat de Negociaci√≥n | Lumers</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .chat-container { height: calc(100vh - 180px); }
    </style>
</head>
<body class="bg-slate-100 min-h-screen">

    <nav class="bg-white border-b border-slate-200 sticky top-0 z-50 px-6 py-4 flex items-center gap-4">
        <a href="Subasta.html" class="text-slate-400">‚¨ÖÔ∏è</a>
        <div>
            <h1 id="chatTitulo" class="text-lg font-extrabold text-slate-800 uppercase tracking-tight text-sm">Cargando Chat...</h1>
            <p class="text-[10px] text-green-500 font-bold uppercase">En l√≠nea ahora</p>
        </div>
    </nav>

    <div id="mensajesChat" class="chat-container overflow-y-auto px-6 py-6 flex flex-col gap-4">
        </div>

    <div class="fixed bottom-0 w-full bg-white border-t border-slate-200 p-4 pb-8">
        <form id="formMensaje" class="max-w-md mx-auto flex gap-2">
            <input type="text" id="inputMensaje" placeholder="Escribe tu oferta..." class="flex-1 bg-slate-100 border-none rounded-2xl px-4 py-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
            <button type="submit" class="bg-blue-600 text-white p-3 rounded-2xl hover:bg-blue-700 transition">
                üöÄ
            </button>
        </form>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, orderBy, onSnapshot, doc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBDWQG6zKK2CDsnHASgE2jtO3DEnU2RsHw",
            authDomain: "lumers-d1d36.firebaseapp.com",
            projectId: "lumers-d1d36",
            storageBucket: "lumers-d1d36.firebasestorage.app",
            messagingSenderId: "798769127070",
            appId: "1:798769127070:web:6b591851e4c5c62758258f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Obtener el ID del paquete desde la URL
        const urlParams = new URLSearchParams(window.location.search);
        const envioId = urlParams.get('id');

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = "index.html";
                return;
            }
            if (envioId) {
                obtenerInfoPaquete();
                escucharMensajes(user);
            }
        });

        async function obtenerInfoPaquete() {
            const docRef = doc(db, "envios", envioId);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                document.getElementById('chatTitulo').innerText = docSnap.data().nombre;
            }
        }

        function escucharMensajes(user) {
            const q = query(
                collection(db, "mensajes"),
                where("envioId", "==", envioId),
                orderBy("fecha", "asc")
            );

            onSnapshot(q, (snapshot) => {
                const contenedor = document.getElementById('mensajesChat');
                contenedor.innerHTML = '';
                
                snapshot.forEach((doc) => {
                    const msg = doc.data();
                    const esMio = msg.usuarioId === user.uid;
                    
                    contenedor.innerHTML += `
                        <div class="flex ${esMio ? 'justify-end' : 'justify-start'}">
                            <div class="max-w-[80%] px-4 py-2 rounded-2xl text-sm font-medium shadow-sm ${esMio ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-white text-slate-800 rounded-tl-none'}">
                                ${msg.texto}
                                <p class="text-[8px] opacity-60 mt-1 text-right">${new Date(msg.fecha?.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
                            </div>
                        </div>
                    `;
                });
                contenedor.scrollTop = contenedor.scrollHeight;
            });
        }

        document.getElementById('formMensaje').addEventListener('submit', async (e) => {
            e.preventDefault();
            const input = document.getElementById('inputMensaje');
            const texto = input.value.trim();

            if (texto && auth.currentUser) {
                await addDoc(collection(db, "mensajes"), {
                    envioId: envioId,
                    texto: texto,
                    usuarioId: auth.currentUser.uid,
                    nombreUsuario: auth.currentUser.displayName,
                    fecha: serverTimestamp()
                });
                input.value = '';
            }
        });
    </script>
</body>
</html>
