<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LUMERS | Panel de Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: white; -webkit-tap-highlight-color: transparent; }
        .card-raider { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); backdrop-filter: blur(15px); }
        .btn-action { background: linear-gradient(90deg, #3b82f6 0%, #2563eb 100%); transition: all 0.3s ease; }
        .btn-action:active { scale: 0.95; }
        .glow-blue { box-shadow: 0 0 20px rgba(59, 130, 246, 0.2); }
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-drop { animation: slideIn 0.4s ease-out forwards; }
    </style>
</head>
<body class="min-h-screen pb-32">

    <div id="guard" class="fixed inset-0 bg-slate-950 z-[100] flex items-center justify-center">
        <div class="text-center">
            <h1 class="text-5xl font-black italic text-blue-500 tracking-tighter mb-2">LUMERS</h1>
            <p class="text-[9px] font-black uppercase tracking-[0.4em] text-white/30 animate-pulse">Sincronizando el mundo...</p>
        </div>
    </div>

    <div id="app-content" class="hidden">
        <header class="p-5 border-b border-white/5 flex justify-between items-center sticky top-0 bg-slate-950/90 backdrop-blur-xl z-50">
            <div>
                <h1 class="text-2xl font-black italic text-white tracking-tighter">LUMERS</h1>
                <p class="text-[8px] font-black text-blue-400 uppercase tracking-widest leading-none">Smart Delivery</p>
            </div>
            <div id="user-info" class="flex items-center gap-3"></div>
        </header>

        <div class="px-5 mt-6">
            <div class="card-raider rounded-[2.5rem] p-6 border-blue-500/20 relative overflow-hidden glow-blue">
                <div class="relative z-10">
                    <h2 class="text-xs font-black text-blue-400 uppercase tracking-[0.2em] mb-1">Membres√≠a Raider Pro</h2>
                    <h3 class="text-xl font-black italic mb-4">¬øLISTO PARA MOVER LA CIUDAD?</h3>
                    <button onclick="solicitarPase()" class="bg-white text-black px-6 py-3 rounded-2xl text-[10px] font-black uppercase tracking-widest hover:bg-blue-50 active:scale-95 transition-all">
                        Activar mi Pase (5 USD)
                    </button>
                </div>
                <i class="fa-solid fa-earth-americas absolute -right-4 -bottom-4 text-8xl opacity-5 rotate-12"></i>
            </div>
        </div>

        <main class="px-5 mt-8 space-y-6 max-w-xl mx-auto" id="lista-viajes">
            <div class="text-center py-20 opacity-20">
                <i class="fa-solid fa-box-open text-4xl mb-4"></i>
                <p class="text-xs font-bold uppercase tracking-widest">Buscando Drops cercanos...</p>
            </div>
        </main>

        <button onclick="abrirModal()" class="fixed bottom-24 right-6 btn-action text-white w-16 h-16 rounded-[2rem] shadow-2xl flex items-center justify-center text-2xl z-50">
            <i class="fa-solid fa-plus"></i>
        </button>

        <footer class="fixed bottom-0 w-full bg-slate-950/90 border-t border-white/5 p-6 flex justify-around backdrop-blur-2xl z-40">
            <button onclick="location.reload()" class="text-blue-500"><i class="fa-solid fa-house-chimney-window text-xl"></i></button>
            <button onclick="cerrarSesion()" class="text-white/20"><i class="fa-solid fa-power-off text-xl"></i></button>
        </footer>
    </div>

    <div id="modal-publicar" class="fixed inset-0 z-[60] hidden bg-black/95 backdrop-blur-xl flex items-center justify-center p-6">
        <div class="w-full max-w-md space-y-5 animate-drop">
            <div class="text-center mb-4">
                <h2 class="text-3xl font-black italic">NUEVO DROP</h2>
                <p class="text-[9px] font-bold text-white/30 uppercase tracking-widest">Preparate para mover el mundo</p>
            </div>
            
            <input type="text" id="v_origen" placeholder="üìç PUNTO DE RETIRO" class="w-full p-5 bg-white/5 rounded-2xl font-bold border border-white/10 outline-none focus:border-blue-500 transition-colors">
            <input type="text" id="v_destino" placeholder="üèÅ PUNTO DE ENTREGA" class="w-full p-5 bg-white/5 rounded-2xl font-bold border border-white/10 outline-none focus:border-blue-500 transition-colors">
            
            <select id="v_tipo" class="w-full p-5 bg-white/5 rounded-2xl font-bold border border-white/10 text-white outline-none">
                <option value="Pie / Bici">üö∂‚Äç‚ôÇÔ∏è A pie / Bici</option>
                <option value="Moto">üèçÔ∏è Moto Raider</option>
                <option value="Auto">üöó Auto / Van</option>
                <option value="Pesado">üöö Transporte Pesado</option>
            </select>

            <div class="flex gap-3">
                <input type="number" id="v_precio" placeholder="üí∞ PRECIO BASE" class="w-2/3 p-5 bg-white/5 rounded-2xl font-bold border border-white/10 outline-none">
                <input type="number" id="v_telefono" placeholder="üì± WHATSAPP" class="w-full p-5 bg-white/5 rounded-2xl font-bold border border-white/10 outline-none">
            </div>

            <button onclick="publicarViaje()" class="w-full btn-action text-white p-5 rounded-3xl font-black uppercase tracking-[0.2em] shadow-lg shadow-blue-500/20">
                LANZAR ESTE DROP
            </button>
            <button onclick="cerrarModal()" class="w-full text-white/20 font-black text-[10px] uppercase tracking-widest mt-2">CANCELAR</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBDWQG6zKK2CDsnHASgE2jtO3DEnU2RsHw",
          authDomain: "lumers-d1d36.firebaseapp.com",
          projectId: "lumers-d1d36",
          storageBucket: "lumers-d1d36.firebasestorage.app",
          messagingSenderId: "798769127070",
          appId: "1:798769127070:web:6b591851e4c5c62758258f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let usuarioActual = null;

        const MI_WHATSAPP = "5493364652349"; 

        onAuthStateChanged(auth, (user) => {
            if (user) {
                usuarioActual = user;
                document.getElementById('user-info').innerHTML = `
                    <span class="text-[10px] font-black text-white/40 uppercase hidden sm:block">${user.displayName.split(" ")[0]}</span>
                    <img src="${user.photoURL}" class="w-10 h-10 rounded-full border-2 border-blue-500 shadow-lg shadow-blue-500/20">
                `;
                escucharViajes();
                setTimeout(() => { 
                    document.getElementById('guard').style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById('guard').classList.add('hidden');
                        document.getElementById('app-content').classList.remove('hidden');
                    }, 500);
                }, 1200);
            } else {
                window.location.replace("index.html");
            }
        });

        function escucharViajes() {
            const q = query(collection(db, "viajes"), orderBy("creado", "desc"));
            onSnapshot(q, (snapshot) => {
                const lista = document.getElementById('lista-viajes');
                lista.innerHTML = "";
                snapshot.forEach((doc) => {
                    const v = doc.data();
                    const id = doc.id;
                    
                    lista.innerHTML += `
                        <div class="card-raider rounded-[2.5rem] p-6 animate-drop">
                            <div class="flex justify-between items-start mb-5">
                                <span class="bg-blue-500 text-white text-[8px] font-black px-3 py-1.5 rounded-full uppercase tracking-widest italic">Drop Activo</span>
                                <p class="text-3xl font-black italic text-white tracking-tighter">$${v.precioBase}</p>
                            </div>
                            
                            <div class="space-y-1 mb-6">
                                <p class="text-[9px] font-black text-blue-500 uppercase tracking-widest">Ruta de entrega</p>
                                <h3 class="text-lg font-black uppercase italic leading-tight">${v.origen} <span class="text-blue-500 mx-1">‚Üí</span> ${v.destino}</h3>
                            </div>

                            <div class="bg-white/5 rounded-[2rem] p-5 mb-5 border border-white/5">
                                <p class="text-[9px] font-black text-white/30 uppercase tracking-widest mb-3 italic">Mejores ofertas Raiders</p>
                                <div id="lista-ofertas-${id}" class="space-y-2 font-bold text-sm italic"></div>
                                <div class="flex gap-2 mt-5">
                                    <input type="number" id="input-${id}" placeholder="Ofertar $" class="w-full bg-black/20 p-4 rounded-2xl outline-none border border-white/5 text-white font-black text-xs">
                                    <button onclick="ofertar('${id}')" class="bg-blue-600 px-6 rounded-2xl font-black text-xs">OK</button>
                                </div>
                            </div>

                            <button onclick="solicitarPase()" class="w-full bg-white text-black p-5 rounded-[2rem] font-black text-[10px] uppercase tracking-[0.1em] flex items-center justify-center gap-2 active:scale-95 transition-all">
                                <i class="fa-solid fa-lock text-blue-600"></i> Ver contacto del drop
                            </button>
                        </div>
                    `;
                    escucharOfertas(id);
                });
            });
        }

        async function escucharOfertas(viajeId) {
            const q = query(collection(db, `viajes/${viajeId}/ofertas`), orderBy("fecha", "desc"), limit(2));
            onSnapshot(q, (snap) => {
                const div = document.getElementById(`lista-ofertas-${viajeId}`);
                div.innerHTML = snap.empty ? "<p class='text-[10px] opacity-20'>Esperando ofertas...</p>" : "";
                snap.forEach(o => {
                    div.innerHTML += `<div class="flex justify-between items-center text-white/70"><span>${o.data().nombre}</span><span class="text-blue-400 font-black">$${o.data().monto}</span></div>`;
                });
            });
        }

        window.solicitarPase = () => {
            const msg = encodeURIComponent("Hola Ani! Quiero mi Pase Pro de 5 USD para mover el mundo con LUMERS üöÄ");
            if(confirm("BLOQUEADO: Para ofertar y ver contactos necesit√°s el PASE PRO. ¬øContactar a Ani?")){
                window.location.href = `https://wa.me/${MI_WHATSAPP}?text=${msg}`;
            }
        };

        window.ofertar = async (viajeId) => {
            const monto = document.getElementById(`input-${viajeId}`).value;
            if(!monto) return;
            // Redirigir al pago antes de ofertar si no es pro
            window.solicitarPase();
        };

        window.publicarViaje = async () => {
            const o = document.getElementById('v_origen').value, d = document.getElementById('v_destino').value, 
                  p = document.getElementById('v_precio').value, t = document.getElementById('v_telefono').value,
                  tipo = document.getElementById('v_tipo').value;
            if(!o || !d || !p || !t) return alert("Complet√° todos los campos del Drop.");
            await addDoc(collection(db, "viajes"), { origen: o, destino: d, precioBase: p, whatsapp: t, tipo: tipo, uid: usuarioActual.uid, creado: Date.now() });
            cerrarModal();
        };

        window.abrirModal = () => document.getElementById('modal-publicar').classList.remove('hidden');
        window.cerrarModal = () => document.getElementById('modal-publicar').classList.add('hidden');
        window.cerrarSesion = () => signOut(auth).then(() => window.location.replace("index.html"));
    </script>
</body>
</html>
